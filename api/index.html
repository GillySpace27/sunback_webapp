
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Solar Archive — Your Sun, Your Day</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="solar-archive.css" rel="stylesheet">
</head>
<body>
<div class="app-container">

  <!-- Hero -->
  <div class="hero">
    <div class="hero-icon"></div>
    <h1>Solar Archive</h1>
    <p>See the Sun on any date. Print it on anything.</p>
  </div>

  <!-- CSP Notice (shown only when served from a different origin) -->
  <div class="backend-banner waking hidden" id="cspNotice">
    <span class="banner-icon"><i class="fas fa-shield-alt"></i></span>
    <div class="banner-text">
      <strong>External resource access required</strong>
      <small>If you see a popup asking to "Allow untrusted external resources," please click <strong>Allow All</strong> — the page will reload and the app will work normally.</small>
    </div>
  </div>

  <!-- Backend Status Banner -->
  <div class="backend-banner checking" id="backendBanner">
    <span class="banner-icon"><div class="spinner"></div></span>
    <div class="banner-text">
      <strong>Checking backend status...</strong>
      <small>Connecting to backend...</small>
    </div>
  </div>

  <!-- Step 1: Select Date & Wavelength -->
  <div class="section">
    <div class="section-header">
      <div class="step-badge">1</div>
      <div class="section-title">Choose Your Date &amp; Wavelength</div>
    </div>

    <div class="controls-grid">
      <div class="field-group">
        <span class="field-label">Date</span>
        <input type="date" id="solarDate">
      </div>
      <div class="field-group">
        <span class="field-label">Mission Data</span>
        <select id="missionSelect">
          <option value="SDO">SDO / AIA (2010–present)</option>
        </select>
      </div>
    </div>

    <div class="wavelength-grid hidden" id="wlGrid">
      <div class="wl-card" data-wl="94">
        <div class="wl-thumb" data-wl="94"></div>
        <div class="wl-value">94 Å</div>
        <div class="wl-label">Green · 6.3MK<br>Hot flaring plasma</div>
      </div>
      <div class="wl-card" data-wl="131">
        <div class="wl-thumb" data-wl="131"></div>
        <div class="wl-value">131 Å</div>
        <div class="wl-label">Teal · 10MK<br>Flares / transition</div>
      </div>
      <div class="wl-card selected" data-wl="171">
        <div class="wl-thumb" data-wl="171"></div>
        <div class="wl-value">171 Å</div>
        <div class="wl-label">Golden · 0.8MK<br>Quiet corona, loops</div>
      </div>
      <div class="wl-card" data-wl="193">
        <div class="wl-thumb" data-wl="193"></div>
        <div class="wl-value">193 Å</div>
        <div class="wl-label">Amber · 1.5MK<br>Corona / flares</div>
      </div>
      <div class="wl-card" data-wl="211">
        <div class="wl-thumb" data-wl="211"></div>
        <div class="wl-value">211 Å</div>
        <div class="wl-label">Purple · 2.0MK<br>Active regions</div>
      </div>
      <div class="wl-card" data-wl="304">
        <div class="wl-thumb" data-wl="304"></div>
        <div class="wl-value">304 Å</div>
        <div class="wl-label">Red · 0.05MK<br>Chromosphere</div>
      </div>
      <div class="wl-card" data-wl="335">
        <div class="wl-thumb" data-wl="335"></div>
        <div class="wl-value">335 Å</div>
        <div class="wl-label">Blue · 2.5MK<br>Active regions</div>
      </div>
      <div class="wl-card" data-wl="1600">
        <div class="wl-thumb" data-wl="1600"></div>
        <div class="wl-value">1600 Å</div>
        <div class="wl-label">UV · 0.1MK<br>Transition region</div>
      </div>
      <div class="wl-card" data-wl="1700">
        <div class="wl-thumb" data-wl="1700"></div>
        <div class="wl-value">1700 Å</div>
        <div class="wl-label">UV · 5000K<br>Photosphere</div>
      </div>
    </div>

    <div class="status-msg" id="statusMsg">
      Select a date, then click a wavelength tile to load your solar image.
    </div>

    <div class="info-row">
      <i class="fas fa-info-circle"></i>
      <span>AIA imagery available from May 2010. Click any tile to instantly preview. <a href="https://www.helioviewer.org" target="_blank" rel="noopener">helioviewer.org</a></span>
    </div>
  </div>

  <!-- Step 3: View & Edit Image (reordered by JS — appears after product selection) -->
  <div class="section hidden" id="editSection">
    <div class="section-header">
      <div class="step-badge">3</div>
      <div class="section-title">View &amp; Edit Your Image</div>
    </div>

    <div class="editor-with-preview">
      <div class="editor-main">
        <div class="image-stage" id="imageStage">
          <img id="solarImg" alt="Solar image" crossorigin="anonymous">
          <canvas id="solarCanvas"></canvas>
          <div class="crop-overlay hidden" id="cropOverlay"></div>
        </div>

    <!-- Edit Tools -->
    <div class="edit-toolbar">
      <div class="edit-toolbar-row">
        <div class="filter-toggle editor-filter" id="editorFilterToggle">
          <span class="field-label" style="margin:0; margin-right:8px;">Filter</span>
          <label class="filter-opt"><input type="radio" name="editorFilter" value="jpg" checked> JPG</label>
          <label class="filter-opt"><input type="radio" name="editorFilter" value="raw"> Raw</label>
          <label class="filter-opt"><input type="radio" name="editorFilter" value="rhef"> RHEF</label>
          <span class="filter-loading-indicator hidden" id="filterLoadingIndicator" title="Preview image generating…"><span class="filter-loading-spinner"></span> Processing…</span>
        </div>
        <div class="filter-toggle vignette-fade-toggle" id="vignetteFadeToggle">
          <span class="field-label" style="margin:0; margin-right:8px;">Background</span>
          <label class="filter-opt active"><input type="radio" name="vignetteFade" value="transparent" checked> Transparent</label>
          <label class="filter-opt"><input type="radio" name="vignetteFade" value="black"> Black</label>
          <label class="filter-opt"><input type="radio" name="vignetteFade" value="white"> White</label>
          <label class="filter-opt filter-opt-mode" title="Use the most common color in the image so the vignette matches the canvas"><input type="radio" name="vignetteFade" value="mode"> Match</label>
          <label class="filter-opt filter-opt-color" title="Custom color">
            <input type="radio" name="vignetteFade" value="custom">
            <input type="color" id="vignetteFadeColorPicker" value="#000000" class="vignette-fade-color-picker" title="Vignette fade color">
            <span class="filter-opt-color-label">Custom</span>
          </label>
        </div>
      </div>
      <div class="filter-status-line" id="filterStatusLine" style="display:none;"></div>
      <div class="edit-toolbar-break"></div>
      <button class="edit-btn" data-tool="pan" title="Pan"><i class="fas fa-hand-paper"></i> Pan</button>
      <button class="edit-btn" data-tool="text" title="Add Text"><i class="fas fa-font"></i> Text</button>
      <button class="edit-btn hidden" id="clockNumbersBtn" data-tool="clockNumbers" title="Customize clock face numerals (wall clock only)"><i class="fas fa-clock"></i> Clock Face</button>
      <button class="edit-btn" data-tool="rotate" title="Rotate 90°"><i class="fas fa-redo"></i> Rotate</button>
      <button class="edit-btn" data-tool="flipH" title="Flip horizontal"><i class="fas fa-arrows-alt-h"></i> Flip H</button>
      <button class="edit-btn" data-tool="flipV" title="Flip vertical"><i class="fas fa-arrows-alt-v"></i> Flip V</button>
      <button class="edit-btn" id="adjustmentsBtn" title="Brightness, contrast, saturation"><i class="fas fa-sliders-h"></i> Adjust</button>
      <button class="edit-btn" data-tool="invert" title="Invert colors"><i class="fas fa-adjust"></i> Invert</button>
      <button class="edit-btn" data-tool="reset" title="Reset"><i class="fas fa-undo"></i> Reset</button>
    </div>

    <!-- Adjustments Panel (brightness, contrast, saturation) -->
    <div class="text-tool-panel hidden" id="adjustmentsPanel">
      <div class="slider-row">
        <label>Brightness</label>
        <input type="range" id="brightnessSlider" min="-100" max="100" value="0">
        <span class="slider-val" id="brightnessVal">0</span>
      </div>
      <div class="slider-row">
        <label>Contrast</label>
        <input type="range" id="contrastSlider" min="-100" max="100" value="0">
        <span class="slider-val" id="contrastVal">0</span>
      </div>
      <div class="slider-row">
        <label>Saturation</label>
        <input type="range" id="saturationSlider" min="0" max="200" value="100">
        <span class="slider-val" id="saturationVal">100</span>
      </div>
    </div>

    <!-- Text Tool Panel -->
    <div class="text-tool-panel hidden" id="textToolPanel">
      <div class="field-row">
        <span class="field-label-sm">Text</span>
        <input type="text" id="textInput" placeholder="Your text here..." value="">
      </div>
      <div class="field-row">
        <span class="field-label-sm">Size</span>
        <input type="range" id="textSizeSlider" min="12" max="200" value="48" style="flex:1;">
        <span class="slider-val" id="textSizeVal" style="min-width:32px;">48</span>
      </div>
      <div class="field-row">
        <span class="field-label-sm">Font</span>
        <select id="textFontSelect"><!-- populated by JS from FONT_CATALOG --></select>
      </div>
      <div class="field-row">
        <span class="field-label-sm">Color</span>
        <input type="color" id="textColorPicker" value="#ffffff">
        <span class="field-label-sm">Stroke</span>
        <input type="color" id="textStrokePicker" value="#000000">
        <span class="field-label-sm" style="min-width:30px;">W</span>
        <input type="range" id="textStrokeWidth" min="0" max="10" value="2" style="flex:1; max-width:100px;">
        <span class="slider-val" id="textStrokeVal" style="min-width:20px;">2</span>
      </div>
      <div class="field-row text-effect-row">
        <span class="field-label-sm" style="min-width:50px;">Shadow</span>
        <label class="toggle-label"><input type="checkbox" id="textShadowToggle"> On</label>
        <input type="color" id="textShadowColor" value="#000000" title="Shadow color">
        <span class="field-label-sm" style="min-width:24px;">Blur</span>
        <input type="range" id="textShadowBlur" min="0" max="30" value="6" style="flex:1; max-width:80px;">
        <span class="slider-val" id="textShadowBlurVal" style="min-width:20px;">6</span>
      </div>
      <div class="field-row text-effect-row">
        <span class="field-label-sm" style="min-width:50px;">Arc</span>
        <label class="toggle-label"><input type="checkbox" id="textArcToggle"> On</label>
        <span class="field-label-sm" style="min-width:24px;">R</span>
        <input type="range" id="textArcRadius" min="50" max="600" value="200" style="flex:1; max-width:120px;">
        <span class="slider-val" id="textArcRadiusVal" style="min-width:30px;">200</span>
      </div>
      <div class="field-row text-effect-row">
        <span class="field-label-sm" style="min-width:50px;">Outline</span>
        <label class="toggle-label"><input type="checkbox" id="textOutlineToggle"> Stroke only (no fill)</label>
      </div>
      <div style="display:flex; gap:8px; margin-top:6px;">
        <button class="edit-btn" id="applyText" style="flex:1;justify-content:center;">
          <i class="fas fa-check"></i> Burn Text Into Image
        </button>
        <button class="edit-btn" id="cancelText">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
      <div class="text-tool-hint">
        <i class="fas fa-arrows-alt"></i>
        <span>Drag the text on the image to position it. Click "Burn" to permanently apply.</span>
      </div>
    </div>

    <!-- Clock Face Panel (wall_clock product only) -->
    <div class="text-tool-panel hidden" id="clockNumbersPanel">
      <div class="field-row">
        <span class="field-label-sm">Style</span>
        <select id="clockNumbersStyleSelect">
          <option value="arabic">Arabic (1, 2, 3…)</option>
          <option value="roman">Roman (I, II, III…)</option>
        </select>
      </div>
      <div class="field-row">
        <span class="field-label-sm">Size</span>
        <input type="range" id="clockNumbersSizeSlider" min="10" max="80" value="28" style="flex:1;">
        <span class="slider-val" id="clockNumbersSizeVal" style="min-width:32px;">28</span>
      </div>
      <div class="field-row">
        <span class="field-label-sm">Radius</span>
        <input type="range" id="clockNumbersRadiusSlider" min="20" max="80" value="42" style="flex:1;">
        <span class="slider-val" id="clockNumbersRadiusVal" style="min-width:32px;">42%</span>
      </div>
      <div class="field-row">
        <span class="field-label-sm">Font</span>
        <select id="clockNumbersFontSelect"><!-- populated by JS from FONT_CATALOG --></select>
      </div>
      <div class="field-row">
        <span class="field-label-sm">Color</span>
        <input type="color" id="clockNumbersColorPicker" value="#ffffff">
        <span class="field-label-sm">Stroke</span>
        <input type="color" id="clockNumbersStrokePicker" value="#000000">
        <span class="field-label-sm" style="min-width:30px;">W</span>
        <input type="range" id="clockNumbersStrokeWidth" min="0" max="10" value="2" style="flex:1; max-width:100px;">
        <span class="slider-val" id="clockNumbersStrokeVal" style="min-width:20px;">2</span>
      </div>
      <div style="display:flex; gap:8px; margin-top:6px;">
        <button class="edit-btn" id="burnClockNumbers" style="flex:1;justify-content:center;">
          <i class="fas fa-check"></i> Burn Numbers Into Image
        </button>
        <button class="edit-btn" id="cancelClockNumbers">
          <i class="fas fa-times"></i> Cancel
        </button>
      </div>
    </div>

    <!-- Sliders (Crop, Vignette, Vig. Edge) -->
    <div class="slider-row">
      <label>Crop</label>
      <input type="range" id="cropSlider" min="50" max="300" value="100" step="1">
      <span class="slider-val" id="cropVal">100%</span>
    </div>
    <div class="slider-row">
      <label>Vignette</label>
      <input type="range" id="vignetteSlider" min="0" max="100" value="76">
      <span class="slider-val" id="vignetteVal">24</span>
    </div>
    <div class="slider-row">
      <label>Vig. Edge</label>
      <input type="range" id="vigWidthSlider" min="0" max="100" value="0">
      <span class="slider-val" id="vigWidthVal">0</span>
    </div>
    <div class="slider-row">
      <label>Crop edge</label>
      <input type="range" id="cropEdgeSlider" min="0" max="100" value="0">
      <span class="slider-val" id="cropEdgeVal">0</span>
    </div>

      </div><!-- /.editor-main -->

      <!-- Selected product mockup preview (side-by-side on wide screens) -->
      <div class="selected-product-preview hidden" id="selectedProductPreview">
        <div class="preview-product-name"></div>
        <div class="preview-mockup"></div>
        <div class="preview-product-ratio"></div>
        <div class="preview-variant-wrap hidden" id="previewVariantWrap">
          <label for="previewVariantSelect">Variant</label>
          <select id="previewVariantSelect" aria-label="Override variant for this product"></select>
          <p class="preview-variant-note hidden" id="previewVariantClockNote">Some options differ by hand color (white vs black).</p>
        </div>
        <button type="button" class="btn-preview-mockup" id="btnPreviewMockup" title="Generate a real Printify mockup for this product, or reset back to the canvas preview.">
          <i class="fas fa-rocket"></i> <span class="btn-preview-mockup-label">Generate real mockup</span>
        </button>
        <button class="btn-buy-in-editor" id="btnBuyInEditor" type="button" title="Create this product on Shopify and complete your purchase.">
          <i class="fas fa-shopping-cart"></i> <span id="btnBuyLabel">Buy / Create on Shopify</span>
        </button>
      </div>
    </div><!-- /.editor-with-preview -->

    <div class="progress-track" id="progressTrack">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Buttons 1/2/3 removed; Buy button is in the preview pane -->
  </div>

  <!-- Step 2: Choose Product (reordered by JS — appears before edit section) -->
  <div class="section hidden" id="productSection">
    <div class="section-header">
      <div class="step-badge">2</div>
      <div class="section-title">Choose Your Product</div>
    </div>

    <p style="color:var(--text-secondary);font-size:13px;margin-bottom:12px;">
      Click a product to select it and choose a size/color variant (click once to expand, again to confirm). Click <strong>Select this product</strong> to open the editor, then use <strong>Buy / Create on Shopify</strong> in the editor to purchase.
    </p>

    <div class="product-grid" id="productGrid"></div>

    <button class="btn-catalog" id="btnCatalog">
      <i class="fas fa-th-large"></i> Browse More Products
    </button>

    <div class="mockup-status" id="mockupStatus"></div>

    <!-- Checkout progress (shown when a purchase is in flight) -->
    <div class="checkout-progress hidden" id="checkoutProgress"></div>

    <div class="send-hint" id="sendHint" style="font-size:12px;color:var(--text-dim);margin-top:6px;text-align:center;">
      Select a date and wavelength to see products. Click a product to choose a variant, then Select this product to edit; buy from the editor.
    </div>

    <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
      <button class="btn-secondary" id="btnShopify">
        <i class="fab fa-shopify"></i> Open Shopify Store
      </button>
      <button class="btn-secondary" id="btnPrintifyDash">
        <i class="fas fa-external-link-alt"></i> Printify Dashboard
      </button>
    </div>

    <div class="status-msg" id="orderStatus"></div>
  </div>

  <div class="app-footer">
    Images courtesy of NASA/SDO. Not affiliated; no endorsement implied.<br>
    Powered by <a href="https://solar-archive.onrender.com" target="_blank" rel="noopener">Solar Archive</a>
    &nbsp;·&nbsp; <span id="buildVersion" style="font-family:monospace;opacity:0.5;font-size:0.7rem;">—</span>
    &nbsp;·&nbsp; <span id="buildTime" style="font-family:monospace;opacity:0.5;font-size:0.7rem;" title="When index.html, solar-archive.js, solar-archive.css were last saved">—</span>
  </div>
</div>

<!-- Catalog modal (rendered by JS) -->
<div id="catalogModal" class="catalog-modal hidden"></div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Crop edge feathered mask (referenced by canvas) -->
<svg id="cropEdgeMaskSvg" aria-hidden="true" style="position:absolute;width:0;height:0;pointer-events:none">
  <defs>
    <filter id="cropEdgeFeatherFilter" x="-0.2" y="-0.2" width="1.4" height="1.4">
      <feGaussianBlur id="cropEdgeFeatherBlur" in="SourceGraphic" stdDeviation="0"/>
    </filter>
    <mask id="cropEdgeMask" maskUnits="objectBoundingBox" maskContentUnits="objectBoundingBox">
      <rect x="0" y="0" width="1" height="1" fill="white" filter="url(#cropEdgeFeatherFilter)"/>
    </mask>
  </defs>
</svg>

<script src="solar-archive.js"></script>
</body>
</html>
