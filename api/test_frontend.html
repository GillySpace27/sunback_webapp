<div id="solar-archive-section"
     style="text-align:center; padding:2em; background:#fff; color:#111;">
  <h2 style="margin-bottom:1em;">Solar Archive ‚Äî Custom Print Generator</h2>

  <form id="solar-archive-form" style="margin-bottom:1.5em;">
    <button id="clearCacheBtn" class="action-btn">Clear Cache</button>
  <style>
    #clearCacheBtn {
      background-color: #e05d44;
      color: white;
      border: none;
      padding: 0.6em 1.2em;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 0.5em;
    }
    #clearCacheBtn:hover {
      background-color: #c2442e;
    }
  </style>

  <style>
  .action-btn {
    background-color: #4a9fff;
    color: white;
    border: none;
    padding: 0.6em 1.2em;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    margin: 0.3em;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
  }

  .action-btn:hover {
    background-color: #2f7ed8;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
    transform: translateY(-1px);
  }

  .action-btn:active {
    background-color: #256bb3;
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  }

  .action-btn:disabled {
    background-color: #bbb;
    color: #eee;
    cursor: not-allowed;
    box-shadow: none;
    transform: none;
  }

  /* Distinct red variant for Clear Cache */
  #clearCacheBtn.action-btn {
    background-color: #e05d44;
  }
  #clearCacheBtn.action-btn:hover {
    background-color: #c2442e;
  }
  #clearCacheBtn.action-btn:active {
    background-color: #a5301b;
  }
</style>


    <label>Date:
      <input type="date" id="solar-date" required style="margin:0.5em;">
    </label>
    <label>Wavelength (√Ö):
  <select id="solar-wavelength" required style="margin:0.5em; padding:0.3em;">
    <optgroup label="EUV Channels">
      <option value="94" style="color:#00c3ff;">94 √Ö ‚Äî Fe XVIII (hot flare plasma, teal)</option>
      <option value="131" style="color:#8c52ff;">131 √Ö ‚Äî Fe VIII / XXI (flare footpoints, violet)</option>
      <option value="171" style="color:#ffd700;" selected>171 √Ö ‚Äî Fe IX (quiet corona loops, golden)</option>
      <option value="193" style="color:#ff9f00;">193 √Ö ‚Äî Fe XII / XXIV (corona + flares, amber)</option>
      <option value="211" style="color:#a020f0;">211 √Ö ‚Äî Fe XIV (active region corona, purple)</option>
      <option value="304" style="color:#ff3030;">304 √Ö ‚Äî He II (chromosphere & prominences, red)</option>
      <option value="335" style="color:#5b5bff;">335 √Ö ‚Äî Fe XVI (hot active regions, blue-violet)</option>
    </optgroup>
    <optgroup label="UV / Visible Channels">
      <option value="1600" style="color:#ff80ff;">1600 √Ö ‚Äî C IV + continuum (transition region, pink)</option>
      <option value="1700" style="color:#ffb3b3;">1700 √Ö ‚Äî Continuum (photosphere, light peach)</option>
      <option value="4500" style="color:#999;">4500 √Ö ‚Äî Visible continuum (white light / HMI, gray-white)</option>
    </optgroup>
  </select>
</label>
    <button type="button" id="generate-btn" class="action-btn">
      Generate Preview
    </button>
  </form>

  <div id="solar-status" style="color:#444; margin-bottom:0.5em;">Waiting for input...</div>
  <div id="progress-container" style="display:none;width:80%;margin:1em auto;background:#eee;border-radius:8px;overflow:hidden;">
    <div id="progress-bar" style="height:16px;width:0%;background:#4a9fff;border-radius:8px;transition:width 0.3s;"></div>
  </div>
  <!-- <div id="log-toggle-container" style="margin: 1em auto; text-align: center;">
    <label style="cursor:pointer;">
      <input type="checkbox" id="toggle-log" style="margin-right: 0.3em;">
      Show Live Log
    </label>
  </div>
  <div id="console-box" style="display:none;width:90%;max-height:180px;overflow-y:auto;background:#111;color:#0f0;font-family:monospace;padding:0.5em;margin:1em auto;border-radius:6px;text-align:left;font-size:0.9em;">
    üõ∞Ô∏è Live Log
  </div> -->
  <img id="solar-image"
       alt="Solar preview"
       style="display:none; width:800px; max-width:90%; border-radius:8px; box-shadow:0 0 25px rgba(0,0,0,0.15); margin:1em auto;">
  <div id="solar-cart" style="margin-top:1em;"></div>
</div>

<script>
const API_BASE = window.location.origin;
const previewImg = document.getElementById("solar-image");
const statusBox = document.getElementById("solar-status");
const generateBtn = document.getElementById("generate-btn");

generateBtn.onclick = async () => {
  const date = document.getElementById("solar-date").value;
  const wavelength = document.getElementById("solar-wavelength").value;
  if (!date) return alert("Select a date first.");

  statusBox.textContent = "Fetching preview...";
  generateBtn.disabled = true;

  try {
    // Step 1: fetch preview
    const payload = { date, wavelength: parseInt(wavelength), mission: "SDO", annotate: false };
    const res = await fetch(`${API_BASE}/api/generate_preview`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    const data = await res.json();
    const previewUrl = data.preview_url || data.url || data.path || data.png_url;
    if (!previewUrl) throw new Error("No preview URL returned from server");

    previewImg.src = previewUrl.startsWith("/asset")
      ? `${API_BASE}${previewUrl}`
      : previewUrl;
    previewImg.style.display = "block";
    statusBox.textContent = "‚úÖ Preview ready";

    // Step 2: generate HQ image
statusBox.textContent = "Rendering HQ proof... (this may take a minute)";
const hqRes = await fetch(`${API_BASE}/api/generate`, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    date,
    mission: "SDO",
    wavelength: parseInt(wavelength),
    detector: "AIA",
    annotate: true,
  }),
});

const hqData = await hqRes.json();

// Case 1: backend returned the PNG immediately
if (hqData.png_url) {
  showHQImage(hqData.png_url);
}
// Case 2: backend returned a task_id (asynchronous job)
else if (hqData.task_id) {
  statusBox.textContent = "HQ render queued, waiting for completion...";
  const taskId = hqData.task_id;

  // Poll every 5 seconds until image is ready
  for (let i = 0; i < 40; i++) { // up to ~3 minutes max
    await new Promise(r => setTimeout(r, 5000));
    const check = await fetch(`${API_BASE}/api/status?job_id=${taskId}`);
    const statusData = await check.json();
    console.log("[poll]", statusData);
    if (statusData.png_url) {
      showHQImage(statusData.png_url);
      break;
    }
    if (i % 4 === 0) statusBox.textContent = `Still rendering... (${i*5}s)`;
  }
}
else {
  throw new Error("HQ render response missing both png_url and task_id");
}

function showHQImage(url) {
  const resolved = url.startsWith("/asset") ? `${API_BASE}${url}` : url;
  previewImg.src = resolved;
  previewImg.style.display = "block";
  statusBox.textContent = "‚úÖ HQ image ready ‚Äî uploading to Printful...";
}

    // Step 3: upload to Printful
    const upload = await fetch(`${API_BASE}/api/upload_to_printful`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        image_path: `/tmp/output/${hqData.png_url.split("/").pop()}`,
        title: `Sun on ${date}`,
      }),
    });

    const uploadData = await upload.json();
    if (uploadData.file_id) {
      alert(`‚úÖ Uploaded to Printful! File ID: ${uploadData.file_id}`);
      statusBox.textContent = "‚úÖ Uploaded to Printful!";
    } else {
      alert("‚ùå Upload failed.");
      statusBox.textContent = "Upload failed.";
    }
  } catch (err) {
    console.error(err);
    statusBox.textContent = "Error during process.";
    alert(err.message);
  } finally {
    generateBtn.disabled = false;
  }
};
</script>